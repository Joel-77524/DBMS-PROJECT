<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annabelle | Dynamic Movie Review</title>
    <!-- Load Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for icons (stars, quotes) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
    <style>
        /* Custom Tailwind Configuration (using Inter font stack) */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar style for better aesthetics on dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #fca5a5; /* Red-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #1f2937; /* Dark background */
        }
        /* Custom CSS for rating stars in the modal */
        .rating-stars input {
            display: none;
        }
        .rating-stars label {
            float: right;
            cursor: pointer;
            color: #4b5563; /* Gray-600 */
            transition: color 0.2s;
        }
        .rating-stars input:checked ~ label,
        .rating-stars label:hover,
        .rating-stars label:hover ~ label {
            color: #f59e0b; /* Amber-500 */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#111827', // dark blue-gray
                        'dark-card': '#1f2937', // slightly lighter dark card
                        'accent-red': '#ef4444', // Red-500 for accents
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg text-gray-100 min-h-screen">

    <!-- Header / Navigation -->
    <header class="bg-gray-900 shadow-xl sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-accent-red tracking-wider">
                Cine<span class="text-gray-100">Review</span>
            </h1>
            <nav class="hidden md:flex space-x-6 text-sm font-medium">
                <a href="#" class="text-gray-300 hover:text-accent-red transition duration-200">Home</a>
                <a href="#" class="text-accent-red transition duration-200">Reviews</a>
                <a href="#" class="text-gray-300 hover:text-accent-red transition duration-200">Top Rated</a>
            </nav>
        </div>
    </header>

    <!-- Main Movie Content Section -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Notification Area for Success/Error Messages -->
        <div id="message-box" class="fixed top-20 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-all duration-300 transform translate-x-full opacity-0"></div>

        <!-- Movie Header (Image and Details) -->
        <section class="flex flex-col md:flex-row gap-8 bg-dark-card rounded-xl p-6 shadow-2xl">
            
            <!-- Movie Poster Placeholder -->
            <div class="w-full md:w-1/3 flex-shrink-0">
                <img 
                    src="../IMG/annabelle.jpg" 
                    alt="Annabelle (2014) Movie Poster" 
                    class="rounded-lg shadow-xl w-full object-cover aspect-[2/3] transition duration-500 ease-in-out transform hover:scale-[1.02]"
                    onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/d1d5db?text=Image+Unavailable';"
                >
            </div>

            <!-- Movie Details & Description -->
            <div class="md:w-2/3">
                <h2 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 leading-tight">Annabelle <span class="text-xl text-gray-400">(2014)</span></h2>
                <p class="text-lg text-accent-red mb-4">Horror/Supernatural Horror</p>
                
                <!-- Rating Stars -->
                <div class="mb-6">
                    <span class="text-yellow-400 text-2xl">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </span>
                    <span class="text-gray-400 ml-2 text-sm">(4.5 / 5 - Critics)</span>
                </div>

                <h3 class="text-2xl font-semibold mb-3 border-b border-gray-700 pb-1 text-white">Synopsis</h3>
                <p class="text-gray-300 leading-relaxed mb-6">
                        Annabelle is a supernatural horror that explores the origins of the infamous haunted doll.
                         The film relies heavily on jump scares and typical horror tropes, offering limited genuine suspense.
                         While atmospheric, it falls short of the tension and storytelling seen in The Conjuring.

                </p>

                <!-- Cast and Crew Info -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-bold text-gray-300">Director:</p>
                        <p class="text-gray-400">John R. Leonetti</p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-300">Cast:</p>
                        <p class="text-gray-400">Annabelle Wallis (Mia Form), Ward Horton (John Form), Alfre Woodard (Evelyn), Tony Amendola (Father Perez)</p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-300">Running Time:</p>
                        <p class="text-gray-400">99 minutes</p>
                    </div>
                    <div>
                        <p class="font-bold text-gray-300">Release Date:</p>
                        <p class="text-gray-400">October 3, 2014</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Review Section -->
        <section class="mt-12">
            <h2 class="text-3xl font-bold text-white border-b-4 border-accent-red inline-block pb-1 mb-6">Audience Reviews</h2>
            
            <!-- Dynamic Reviews Container -->
            <!-- Static review cards removed, dynamic content will load here -->
            <div id="reviews-container" class="space-y-8">
                <p class="text-gray-500 text-center py-8">Loading reviews...</p>
            </div>
            
            <!-- Add Your Review Button -->
            <div class="text-center pt-8">
                <button id="open-review-modal" class="bg-accent-red hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    Write Your Own Review
                </button>
            </div>

        </section>
    </main>

    <!-- Footer -->
    <footer class="mt-12 py-6 bg-gray-900 text-gray-500 text-center text-sm">
        <p>&copy; 2024 CineReview. All rights reserved. Data for "Annabelle" for demonstration purposes only.</p>
    </footer>

    <!-- Review Submission Modal (Popup) -->
    <div id="review-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        
        <!-- Modal Content Container -->
        <div class="bg-dark-card rounded-xl shadow-2xl w-full max-w-lg p-6 relative transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            
            <!-- Close Button -->
            <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-accent-red transition duration-150">
                <i class="fas fa-times text-2xl"></i>
            </button>
            
            <h3 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Submit Your Review</h3>
            
            <form id="review-form">
                
                <!-- Reviewer Name -->
                <div class="mb-4">
                    <label for="reviewer-name" class="block text-sm font-medium text-gray-300 mb-1">Enter the Genre</label>
                    <input type="text" id="reviewer-name" name="reviewer-name" required
                           class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-accent-red focus:border-accent-red transition duration-200"
                           placeholder="e.g., Horror Fanatic">
                </div>

                <!-- Star Rating -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Your Rating (1-5)</label>
                    <!-- Star Rating Widget -->
                    <div class="rating-stars flex justify-center text-3xl">
                        <!-- Stars are displayed right-to-left for CSS functionality -->
                        <input type="radio" id="star5" name="rating" value="5" required /><label for="star5" title="5 stars"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars"><i class="fas fa-star"></i></label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star"><i class="fas fa-star"></i></label>
                    </div>
                </div>

                <!-- Review Text Area -->
                <div class="mb-6">
                    <label for="review-text" class="block text-sm font-medium text-gray-300 mb-1">Your Thoughts on the Movie</label>
                    <textarea id="review-text" name="review-text" rows="5" required
                              class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white resize-none focus:ring-accent-red focus:border-accent-red transition duration-200"
                              placeholder="Share your detailed review here..."></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        class="w-full bg-accent-red hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 transform hover:scale-[1.01]">
                    Submit Review
                </button>
            </form>
            
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Base URL for the Flask API
        const API_BASE_URL = 'http://127.0.0.1:5000/api';

        // -----------------------------------------------------------------
        // 1. DYNAMIC REVIEW FETCH AND RENDER LOGIC
        // -----------------------------------------------------------------
        const reviewsContainer = document.getElementById('reviews-container');

        const renderReviewCard = (review) => {
            // Generate star icons based on the rating value
            const solidStars = '<i class="fas fa-star"></i>'.repeat(review.rating);
            const emptyStars = '<span class="text-gray-600"><i class="fas fa-star"></i></span>'.repeat(5 - review.rating);
            
            // Format the date (handle case where created_at is just the date string or a full datetime)
            let dateDisplay = 'N/A';
            try {
                dateDisplay = new Date(review.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            } catch (e) {
                dateDisplay = review.created_at || 'Unknown Date';
            }

            return `
                <article class="bg-dark-card rounded-xl p-6 shadow-lg border-l-4 border-yellow-500 transition duration-300 hover:shadow-xl">
                    <div class="flex justify-between items-center mb-3">
                        <div class="font-bold text-lg text-white">${review.reviewer_name}</div>
                        <div class="text-yellow-400">${solidStars}${emptyStars}</div>
                    </div>
                    <p class="text-gray-300 italic mb-3">
                        <i class="fas fa-quote-left text-accent-red mr-2"></i>
                        ${review.review_text}
                        <i class="fas fa-quote-right text-accent-red ml-2"></i>
                    </p>
                    <p class="text-xs text-gray-500 text-right">Reviewed on ${dateDisplay}</p>
                </article>
            `;
        };

        const fetchAndDisplayReviews = async () => {
            reviewsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Loading reviews...</p>';

            try {
                const movieTitle = 'Annabelle';
                const response = await fetch(`${API_BASE_URL}/get_reviews/${movieTitle}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch reviews from server.');
                }
                const reviews = await response.json();
                
                // Clear the container
                reviewsContainer.innerHTML = ''; 

                if (reviews.length === 0) {
                    reviewsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No audience reviews yet. Be the first!</p>';
                } else {
                    reviews.forEach(review => {
                        reviewsContainer.innerHTML += renderReviewCard(review);
                    });
                }

            } catch (error) {
                console.error("Error fetching reviews:", error);
                reviewsContainer.innerHTML = `<p class="text-red-400 text-center py-8">
                                                Could not load reviews. Ensure the Flask server is running at ${API_BASE_URL} and the database connection is correct.
                                              </p>`;
            }
        };


        // -----------------------------------------------------------------
        // 2. MODAL & FORM SUBMISSION LOGIC
        // -----------------------------------------------------------------
        const modal = document.getElementById('review-modal');
        const modalContent = document.getElementById('modal-content');
        const openBtn = document.getElementById('open-review-modal');
        const closeBtn = document.getElementById('close-modal');
        const reviewForm = document.getElementById('review-form');
        const messageBox = document.getElementById('message-box');

        const showNotification = (message, type) => {
            const baseClasses = "p-4 rounded-lg shadow-xl text-sm";
            let colorClasses = '';

            if (type === 'success') {
                colorClasses = 'bg-green-600';
            } else if (type === 'error') {
                colorClasses = 'bg-red-700';
            }

            messageBox.className = `${baseClasses} ${colorClasses} fixed top-20 right-4 transform translate-x-0 opacity-100 z-50 transition-all duration-300`;
            messageBox.textContent = message;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageBox.classList.remove('translate-x-0', 'opacity-100');
                messageBox.classList.add('translate-x-full', 'opacity-0');
            }, 5000);
        };


        const showModal = () => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        const hideModal = () => {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); 
        };

        // Event listeners for Modal
        if (openBtn) openBtn.addEventListener('click', showModal);
        if (closeBtn) closeBtn.addEventListener('click', hideModal);

        // Close modal when clicking outside the content (on the backdrop)
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });
        }

        // Handle form submission - UPDATED TO USE FETCH
        if (reviewForm) {
            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault(); 
                
                const reviewerName = document.getElementById('reviewer-name').value;
                const reviewText = document.getElementById('review-text').value;
                const ratingElement = reviewForm.querySelector('input[name="rating"]:checked');
                const rating = ratingElement ? ratingElement.value : null;

                const formData = {
                    reviewer_name: reviewerName,
                    rating: rating,
                    review_text: reviewText
                };

                try {
                    const movieTitle = 'Annabelle';
                    const response = await fetch(`${API_BASE_URL}/submit_review/${movieTitle}`, {

                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData) 
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showNotification('Review submitted successfully!', 'success');
                        // Crucial: Refresh the list after successful submission
                        fetchAndDisplayReviews(); 
                    } else {
                        console.error('Submission Error:', result.error);
                        showNotification(`Error: ${result.error || 'Unknown server error.'}`, 'error');
                    }

                } catch (error) {
                    console.error('Network or Server Error:', error);
                    showNotification('Could not connect to the Flask server. Is it running?', 'error');
                }
                
                reviewForm.reset();
                hideModal();
            });
        }
        
        // -----------------------------------------------------------------
        // 3. INITIALIZATION
        // -----------------------------------------------------------------
        // Start fetching reviews when the page loads
        fetchAndDisplayReviews();
        
        // NOTE: Carousel and Toggle logic removed for brevity as they are not relevant 
        // to the database interaction, but you can keep them if needed.
    });
    </script>
</body>
</html>
